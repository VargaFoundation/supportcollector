openapi: 3.0.0
info:
  title: ODPSC API v2.1
  version: 2.1.0
  description: |
    API for managing ODP Support Collector v2.1 diagnostics collection and submission.
    The ODPSC Master exposes these endpoints for agent bundle upload with API key auth,
    bundle management, collection triggers, aggregation, audit, and configuration management.

    Key features in v2.1:
    - Cluster ID for per-cluster correlation
    - Cluster topology collection
    - Audit trail for bundle operations
    - Enhanced diagnostics (service health, HDFS report, YARN queues, alert history, log tails)
  contact:
    name: ODP Support
    url: https://support.odp.com

servers:
  - url: http://master-host:8085/api/v2
    description: ODPSC Master server (v2.1)

paths:
  /bundles/upload:
    post:
      summary: Upload agent diagnostic bundle
      description: |
        Endpoint used by ODPSC Agents to upload their collected diagnostic data bundles.
        Requires API key authentication via Bearer token. Bundles are deduplicated
        using the X-ODPSC-Bundle-ID header.
      operationId: uploadBundle
      tags:
        - Agent
      security:
        - apiKeyAuth: []
      parameters:
        - name: X-ODPSC-Bundle-ID
          in: header
          required: true
          schema:
            type: string
            format: uuid
          description: Unique bundle identifier for deduplication
        - name: X-ODPSC-Cluster-ID
          in: header
          required: false
          schema:
            type: string
          description: Cluster identifier for per-cluster correlation
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - bundle
              properties:
                bundle:
                  type: string
                  format: binary
                  description: ZIP archive containing agent diagnostic data with manifest.json
      responses:
        '200':
          description: Bundle received or duplicate detected
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [received, duplicate]
                  bundle_id:
                    type: string
                  filename:
                    type: string
                  message:
                    type: string
        '400':
          description: Bad request (missing bundle or bundle ID)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid or missing API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many requests (rate limited)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /bundles:
    get:
      summary: List received bundles
      description: Returns a paginated list of all received agent bundles.
      operationId: listBundles
      tags:
        - Bundles
      security:
        - basicAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of bundles
          content:
            application/json:
              schema:
                type: object
                properties:
                  bundles:
                    type: array
                    items:
                      $ref: '#/components/schemas/BundleInfo'
                  count:
                    type: integer
                  total:
                    type: integer
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /bundles/{bundleId}:
    get:
      summary: Download a specific bundle
      description: Download a previously received bundle by its ID.
      operationId: getBundle
      tags:
        - Bundles
      security:
        - basicAuth: []
      parameters:
        - name: bundleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Bundle file
          content:
            application/zip:
              schema:
                type: string
                format: binary
        '404':
          description: Bundle not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /collect:
    post:
      summary: Trigger manual collection
      description: |
        Triggers a manual diagnostic collection cycle via Ambari custom command.
        Agents are instructed to collect data at the specified bundle level.
      operationId: triggerCollect
      tags:
        - Collection
      security:
        - basicAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                level:
                  type: string
                  enum: [L1, L2, L3]
                  default: L1
                  description: |
                    Bundle level: L1 (configs+sysinfo+topology+health), L2 (+metrics+HDFS+YARN+alerts), L3 (+full logs)
                send:
                  type: boolean
                  default: false
                  description: If true, send aggregated bundle to support after collection
      responses:
        '200':
          description: Collection triggered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: triggered
                  level:
                    type: string
                  message:
                    type: string
        '403':
          description: Collection is disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /aggregate:
    post:
      summary: Trigger bundle aggregation
      description: |
        Triggers aggregation of all pending (non-aggregated) bundles into a single
        master bundle with analysis. Optionally archives to HDFS.
      operationId: triggerAggregate
      tags:
        - Collection
      security:
        - basicAuth: []
      responses:
        '200':
          description: Aggregation completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [aggregated, no_pending]
                  output:
                    type: string
                    description: Path to aggregated bundle
                  agent_count:
                    type: integer
                  bundles_processed:
                    type: integer
                  hdfs_path:
                    type: string
                    nullable: true
                  message:
                    type: string
        '500':
          description: Aggregation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /config:
    get:
      summary: Get current configuration
      description: |
        Returns the current ODPSC configuration. Sensitive fields
        (tokens, passwords, encryption keys, API keys) are masked.
      operationId: getConfig
      tags:
        - Configuration
      security:
        - basicAuth: []
      responses:
        '200':
          description: Current configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Config'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      summary: Update configuration
      description: |
        Update one or more configuration properties. Only whitelisted
        properties can be modified. Password changes are hashed with bcrypt.
      operationId: updateConfig
      tags:
        - Configuration
      security:
        - basicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigUpdate'
      responses:
        '200':
          description: Configuration updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: updated
                  applied:
                    type: array
                    items:
                      type: string
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /status:
    get:
      summary: Get master status
      description: Returns the current operational status of the ODPSC Master.
      operationId: getStatus
      tags:
        - Status
      security:
        - basicAuth: []
      responses:
        '200':
          description: Current status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: running
                  version:
                    type: string
                    example: "2.1"
                  cluster_id:
                    type: string
                    description: Unique cluster identifier
                  collection_enabled:
                    type: boolean
                  auto_send_enabled:
                    type: boolean
                  send_frequency:
                    type: string
                  hdfs_archive_enabled:
                    type: boolean
                  audit_enabled:
                    type: boolean
                  bundle_count:
                    type: integer
                  pending_bundles:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /audit:
    get:
      summary: Get audit events
      description: |
        Returns paginated audit events. Only available when audit_enabled is true.
        Audit events track all bundle operations for transparency.
      operationId: getAuditEvents
      tags:
        - Audit
      security:
        - basicAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: event_type
          in: query
          schema:
            type: string
            enum: [bundle_received, bundle_aggregated, bundle_sent]
          description: Filter by event type
      responses:
        '200':
          description: List of audit events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  count:
                    type: integer
                  total:
                    type: integer
        '403':
          description: Audit is not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /audit/{bundleId}:
    get:
      summary: Get audit events for a specific bundle
      description: Returns all audit events associated with a specific bundle ID.
      operationId: getAuditForBundle
      tags:
        - Audit
      security:
        - basicAuth: []
      parameters:
        - name: bundleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Audit events for the bundle
          content:
            application/json:
              schema:
                type: object
                properties:
                  bundle_id:
                    type: string
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  count:
                    type: integer
        '403':
          description: Audit is not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: Basic authentication with admin username and bcrypt-hashed password

    apiKeyAuth:
      type: http
      scheme: bearer
      description: API key authentication for agent bundle uploads

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message

    BundleInfo:
      type: object
      properties:
        bundle_id:
          type: string
          format: uuid
        hostname:
          type: string
        filename:
          type: string
        level:
          type: string
          enum: [L1, L2, L3]
        size_bytes:
          type: integer
        cluster_id:
          type: string
          description: Cluster identifier
        received_at:
          type: string
          format: date-time
        aggregated:
          type: integer
          description: 1 if aggregated, 0 if pending

    AuditEvent:
      type: object
      properties:
        id:
          type: integer
        timestamp:
          type: string
          format: date-time
        event_type:
          type: string
          enum: [bundle_received, bundle_aggregated, bundle_sent]
        bundle_id:
          type: string
        cluster_id:
          type: string
        hostname:
          type: string
        direction:
          type: string
          enum: [inbound, outbound]
        destination:
          type: string
        size_bytes:
          type: integer
        content_summary:
          type: string
          description: JSON list of files in the bundle with sizes
        details:
          type: string

    Config:
      type: object
      properties:
        collection_enabled:
          type: boolean
        auto_send_enabled:
          type: boolean
        send_frequency:
          type: string
          enum: [daily, weekly, monthly]
        support_endpoint:
          type: string
          format: uri
        support_token:
          type: string
          description: Masked in response
        hdfs_path:
          type: string
        hdfs_archive_enabled:
          type: boolean
        log_paths:
          type: array
          items:
            type: string
        master_port:
          type: integer
        admin_username:
          type: string
        admin_password_hash:
          type: string
          description: Masked in response
        api_key:
          type: string
          description: Masked in response
        encryption_key:
          type: string
          description: Masked in response
        max_upload_size_mb:
          type: integer
        max_bundle_size_mb:
          type: integer
        bundle_level:
          type: string
          enum: [L1, L2, L3]
        gunicorn_workers:
          type: integer
        cluster_id:
          type: string
          description: Unique cluster identifier
        audit_enabled:
          type: boolean
          description: Whether audit logging is enabled

    ConfigUpdate:
      type: object
      description: Partial configuration update. Only include properties to change.
      properties:
        collection_enabled:
          type: boolean
        auto_send_enabled:
          type: boolean
        send_frequency:
          type: string
          enum: [daily, weekly, monthly]
        support_endpoint:
          type: string
          format: uri
        support_token:
          type: string
        hdfs_path:
          type: string
        hdfs_archive_enabled:
          type: boolean
        log_paths:
          type: array
          items:
            type: string
        admin_username:
          type: string
        admin_password:
          type: string
          description: Will be hashed with bcrypt before storage
        encryption_key:
          type: string
        max_upload_size_mb:
          type: integer
        max_bundle_size_mb:
          type: integer
        bundle_level:
          type: string
          enum: [L1, L2, L3]
        audit_enabled:
          type: boolean
          description: Enable or disable audit logging
